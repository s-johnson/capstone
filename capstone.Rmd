---
title: "MCAH Capstone"
author: "Sarah Johnson"
output: pdf_document
---

# Load libraries

```{r}
library(srvyr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(naniar)
library(haven)
library(dagitty)
library(ggdag)
library(tableone)
library(survey)
library(svydiags)
library(kableExtra)
library(Hmisc)
library(Gmisc)
library(magick)
library(plotrix)
library(summarytools)
library(jtools)
library(lmtest)
library(aod)
library(interactions)
library(ggstance)
library(mice)
library(mitools)

data_path <- "/Volumes/usts_data/data/"
```

# Load original data

```{r eval=FALSE}
data.all <- read_dta(paste(data_path,"./14818577/ICPSR_37229/DS0001/37229-0001-Data-REST.dta", sep = ""))
```

```{r}
load(paste(data_path, "data.all.Rda", sep = ""))
```

# Replace certain values with NAs

```{r, eval=FALSE}
rep_na_num <- c("Q1_13", "YRSSINCEFT", "AGEMOYR", "Q3_1", "Q3_2", "Q3_3", "Q4_10", "Q10_9", "Q12_10", "Q12_11", "Q12_16", "Q12_19", "AGESURGERY", "Q13_3", "Q16_10", "Q16_11", "Q16_12", "AGEFIRSTATTEMPT", "AGELASTATTEMPT", "Q17_7")

rep_na_lim <- c("FAMSUPPORT3")

rep_na_other <- names(data.all)[!names(data.all) %in% c("IDCODE",rep_na_num, rep_na_lim)]
```

```{r, eval=FALSE}
rep_w_na_num <- function(x) {
  x[x %in% c(888,999)] = NA
  return(x)
}

data.all[rep_na_num] <- apply(data.all[rep_na_num], 2, rep_w_na_num)

rep_w_na_lim <- function(x) {
  x[x %in% c(99)] = NA
  return(x)
}

data.all[rep_na_lim] <- apply(data.all[rep_na_lim], 2, rep_w_na_lim)

rep_w_na_other <- function(x) {
  x[x %in% c(77,88,99)] = NA
  return(x)
}

data.all[rep_na_other] <- apply(data.all[rep_na_other], 2, rep_w_na_other)

all_but_time <- names(data.all)[names(data.all) != "TIMESUBMITTED"]
data.all[all_but_time] <- apply(data.all[all_but_time], 2, as.numeric)

save(data.all, file = paste(data_path, "data.all.raw.Rda", sep = ""))
```

```{r}
load(paste(data_path, "data.all.raw.Rda", sep = ""))
```


# Create discrimination variables

```{r }
data.all <- data.all %>% 
  dplyr::mutate(disc.age = dplyr::select(.,
                                         Q17_4_1, 
                                         Q17_5_1 , 
                                         Q17_9_1 , 
                                         Q21_8_1_1 , 
                                         Q21_8_2_1 , 
                                         Q21_8_3_1 , 
                                         Q24_2_1) %>% 
                  rowSums(na.rm = TRUE),
                disc.disability = dplyr::select(.,
                                                Q17_4_2 , 
                                                Q17_5_2 , 
                                                Q17_9_2 , 
                                                Q21_8_1_2 , 
                                                Q21_8_2_2 ,
                                                Q21_8_3_2 , 
                                                Q24_2_2) %>% 
                  rowSums(na.rm = TRUE),
                disc.income.education = dplyr::select(.,
                                                      Q17_4_3 ,
                                                      Q17_5_3 ,
                                                      Q17_9_3 ,
                                                      Q21_8_1_3 , 
                                                      Q21_8_2_3 , 
                                                      Q21_8_3_3 , 
                                                      Q24_2_3) %>% 
                  rowSums(na.rm = TRUE),
                disc.race = dplyr::select(.,
                                          Q17_4_6 ,
                                          Q17_5_6 ,
                                          Q17_9_6 , 
                                          Q21_8_1_6 , 
                                          Q21_8_2_6 , 
                                          Q21_8_3_6 , 
                                          Q24_2_6) %>% 
                  rowSums(na.rm = TRUE),
                disc.religion = dplyr::select(.,
                                              Q17_4_7 ,
                                              Q17_5_7 , 
                                              Q17_9_7 , 
                                              Q21_8_1_7 ,
                                              Q21_8_2_7 ,
                                              Q21_8_3_7 ,
                                              Q24_2_7) %>% 
                  rowSums(na.rm = TRUE),
                disc.orientation = dplyr::select(.,
                                                 Q17_4_8 ,
                                                 Q17_5_8 ,
                                                 Q17_9_8 , 
                                                 Q21_8_1_8 ,
                                                 Q21_8_2_8 , 
                                                 Q21_8_3_8 , 
                                                 Q24_2_8) %>% 
                  rowSums(na.rm = TRUE),
                disc.other = dplyr::select(.,
                                           Q17_4_9 , 
                                           Q17_5_9 , 
                                           Q17_9_9 , 
                                           Q21_8_1_9 , 
                                           Q21_8_2_9 , 
                                           Q21_8_3_9 , 
                                           Q24_2_9) %>% 
                  rowSums(na.rm = TRUE),
                disc.trans = dplyr::select(.,
                                           Q17_4TRANSGE ,
                                           Q17_5TRANSGE , 
                                           Q17_9TRANSGE ,
                                           Q21_8_1TRANSGE , 
                                           Q21_8_2TRANSGE , 
                                           Q21_8_3TRANSGE ,
                                           Q24_2TRANSGE) %>% 
                  rowSums(na.rm = TRUE),)  %>% 
  dplyr::mutate(disc.non.trans = dplyr::select(.,
                                               disc.age ,
                                               disc.disability ,
                                               disc.income.education , 
                                               disc.race , 
                                               disc.religion , 
                                               disc.orientation , 
                                               disc.other) %>% 
                  rowSums(na.rm = TRUE),)
```

# Create affirmation variables

```{r}
data.all <- data.all %>%
  dplyr::mutate(saab = factor(Q2_1 - 1,
                              labels = c("AFAB",
                                         "AMAB"))) %>%
  dplyr::mutate(affirm.provider = ((Q11_4 == 2) | (Q11_4 == 3) | 
                                     (Q11_7 == 2) | (Q11_7 == 3)),
                affirm.family = (FAMSUPPORT3 == 1),
                affirm.id.name = (-1*Q10_13 + 3),
                affirm.id.gender = (-1*Q10_15 + 3),
                Q12_8eq9_1 = Q12_8_1 == Q12_9_1,
                Q12_8eq9_2 = Q12_8_2 == Q12_9_2,
                Q12_8eq9_3 = Q12_8_3 == Q12_9_3,
                Q12_15_1new = (saab == "AFAB")&((Q12_15_1 == 1) | (Q12_15_1 == 4)),
                Q12_15_2new = (saab == "AFAB")&((Q12_15_2 == 1) | (Q12_15_2 == 4)),
                Q12_15_3new = (saab == "AFAB")&((Q12_15_3 == 1) | (Q12_15_3 == 4)),
                Q12_15_4new = (saab == "AFAB")&((Q12_15_4 == 1) | (Q12_15_4 == 4)),
                Q12_15_5new = (saab == "AFAB")&((Q12_15_5 == 1) | (Q12_15_5 == 4)),
                Q12_18_1new = (saab == "AMAB")&((Q12_18_1 == 1) | (Q12_18_1 == 4)),
                Q12_18_2new = (saab == "AMAB")&((Q12_18_2 == 1) | (Q12_18_2 == 4)),
                Q12_18_3new = (saab == "AMAB")&((Q12_18_3 == 1) | (Q12_18_3 == 4)),
                Q12_18_4new = (saab == "AMAB")&((Q12_18_4 == 1) | (Q12_18_4 == 4)),
                Q12_18_5new = (saab == "AMAB")&((Q12_18_5 == 1) | (Q12_18_5 == 4)),
                Q12_18_6new = (saab == "AMAB")&((Q12_18_6 == 1) | (Q12_18_6 == 4)),
                Q12_18_7new = (saab == "AMAB")&((Q12_18_7 == 1) | (Q12_18_7 == 4)),
                Q12_18_8new = (saab == "AMAB")&((Q12_18_8 == 1) | (Q12_18_8 == 4)),
                Q12_18_9new = (saab == "AMAB")&((Q12_18_9 == 1) | (Q12_18_9 == 4)),
                Q12_18_10new = (saab == "AMAB")&((Q12_18_10 == 1) | (Q12_18_10 == 4)),
  ) %>%
  dplyr::mutate(Q12_8eq9_all = Q12_8eq9_1 & Q12_8eq9_2 & Q12_8eq9_3,
                Q12_15or18_all = ((saab == "AFAB") &
                                    (Q12_15_1new & Q12_15_2new & Q12_15_3new & 
                                       Q12_15_4new & Q12_15_5new)) | 
                  ((saab == "AMAB") &
                     (Q12_18_1new & Q12_18_2new & Q12_18_3new & 
                        Q12_18_4new & Q12_18_5new & Q12_18_6new &
                        Q12_18_7new & Q12_18_8new & Q12_18_9new &
                        Q12_18_10new)),
  ) %>% dplyr::mutate(Q12_8eq9_some = (Q12_8eq9_1 | Q12_8eq9_2 | Q12_8eq9_3) & (!Q12_8eq9_all),
                      Q12_15or18_some = (((saab == "AFAB") & ((Q12_15_1new | Q12_15_2new | Q12_15_3new |
                                                                 Q12_15_4new | Q12_15_5new))) | 
                                           ((saab == "AMAB") &
                                              ((Q12_18_1new | Q12_18_2new | Q12_18_3new | 
                                                  Q12_18_4new | Q12_18_5new | Q12_18_6new |
                                                  Q12_18_7new | Q12_18_8new | Q12_18_9new |
                                                  Q12_18_10new)))) & (!Q12_15or18_all),
                      
  ) %>%
  dplyr::mutate(affirm.hormone = (Q12_8eq9_all*2 + Q12_8eq9_some*1),
                affirm.med.surg = (Q12_15or18_all*2 + Q12_15or18_some*1),
  ) %>%
  dplyr::mutate(affirm.total = dplyr::select(.,
                                             affirm.provider,
                                             affirm.family,
                                             affirm.id.name, 
                                             affirm.id.gender, 
                                             affirm.hormone, 
                                             affirm.med.surg) %>% 
                  rowSums(na.rm = TRUE),) %>%
  dplyr::mutate(affirm.provider = factor(affirm.provider,
                                         labels = c("Not knowledgeable/Not sure/No provider",
                                                    "Knowledgeable")),
                affirm.family = factor(affirm.family,
                                       labels = c("Not supportive",
                                                  "Supportive")),
                affirm.id.name = factor(affirm.id.name,
                                        labels = c("None",
                                                   "Some",
                                                   "All")),
                affirm.id.gender = factor(affirm.id.gender,
                                          labels = c("None",
                                                     "Some",
                                                     "All")),
                affirm.hormone = factor(affirm.hormone,
                                        labels = c("None",
                                                   "Some",
                                                   "All")),
                affirm.med.surg = factor(affirm.med.surg,
                                         labels = c("None",
                                                    "Some",
                                                    "All")),)

```

# Create factor variables

```{r }
data.all <- data.all %>%
  dplyr::mutate(suicidal = factor(Q16_1,
                                  labels = c("No Suicidal Ideation",
                                             "Suicidal Ideation")),
                military = factor(Q2_17 != 1,
                                  labels = c("Not Military",
                                             "Military")),
                intersex = factor(Q2_2_13,
                                  labels = c("Not Intersex",
                                             "Intersex")),
                insurance = factor(Q11_1,
                                   labels = c("No Health Insurance",
                                              "Health Insurance")),
                homelessness = factor(Q23_1,
                                      labels = c("Never Homeless",
                                                 "Ever Homeless")),
                sexwork = factor(ANYSEXWORK,
                                 labels = c("Never Sex Work",
                                            "Ever Sex Work")),
                illegalwork = factor(Q6_11ANY,
                                     labels = c("Never Illegal (Non-Sex) Work",
                                                "Ever Illegal (Non-Sex) Work")),
                alcohol = factor(HEAVYALCOHOL,
                                 labels = c("No Heavy Alcohol Use",
                                            "Heavy Alcohol Use")),
                sexualassault = factor(Q18_1,
                                       labels = c("Never Sexually Assaulted",
                                                  "Ever Sexually Assaulted")),
                orientation = factor(Q2_8CAT7, 
                                     labels = c("Asexual",
                                                "Bisexual",
                                                "Gay/Lesbian/SGL",
                                                "Heterosexual/Straight",
                                                "Pansexual",
                                                "Queer",
                                                "S.O. not listed")),
                citizenship = factor(CITIZEN3,
                                     labels = c("U.S. citizen",
                                                "Documented resident",
                                                "Undocumented resident")),
                passing = factor(VISUALCONFORMITY,
                                 labels = c("Not Passing as Cisgender",
                                            "Somewhat Passing as Cisgender",
                                            "Passing as Cisgender")),
                outness = factor(OUTNESS,
                                 labels = c("None",
                                            "Some",
                                            "Most",
                                            "All")),
                race = factor(RACEACS2,
                              labels = c("Alaska Native/American Indian alone",
                                         "Asian/Native Hawaiian/Pacific Islander alone",
                                         "Biracial/Multiracial/Not listed",
                                         "Black/African American alone",
                                         "Latino/a/Hispanic alone",
                                         "White/Middle Eastern/North African alone")),
                age = Q2_13,
                education = factor(EDUCATION4,
                                   labels = c("Less than high school",
                                              "High school grad (incl. GED)",
                                              "Some college (no degree)/Associate's",
                                              "Bachelor's degree or higher")),
                disability = factor(ANYACSDIS, 
                                    labels = c("No Disability",
                                               "Disability")),
                religious = factor(RELIGIOUS, 
                                   labels = c("Not religious/spiritual",
                                              "Religious/Spiritual")),
                nonbinary = factor(GENDER2,
                                   labels = c("Trans",
                                              "GQ/NB")),
                poverty = factor(POVERTY,
                                 labels = c("Not Living At/Near Poverty",
                                            "Living At/Near Poverty")),
                overall = "Overall"
  )

# Re-level factor variables where needed
data.all$race <- relevel(data.all$race, ref = "White/Middle Eastern/North African alone")
data.all$orientation <- relevel(data.all$orientation, ref = "Heterosexual/Straight")
#data.all$education <- relevel(data.all$education, ref = "High school grad (incl. GED)")
```


```{r}
label(data.all$suicidal) <- "Suicidal Ideation"
label(data.all$citizenship) <- "Citizenship"
label(data.all$passing) <- "Passing as Cisgender"
label(data.all$outness) <- "Outness" 
label(data.all$orientation) <-  "Sexual Orientation"
label(data.all$race) <-  "Race"
label(data.all$age) <-  "Age"
label(data.all$education) <-  "Education"
label(data.all$disability) <-  "Disability"
label(data.all$military) <- "Military"  
label(data.all$religious) <-  "Religious"
label(data.all$nonbinary) <-  "Nonbinary"
label(data.all$intersex) <-  "Intersex"
label(data.all$disc.non.trans) <-  "Non-Trans Discrimination"
label(data.all$disc.trans) <- "Trans Discrimination" 
label(data.all$affirm.total) <- "Total Affirmation"
label(data.all$affirm.provider) <- "Knowledgeable Provider"
label(data.all$affirm.family) <- "Family Affirmation"
label(data.all$affirm.id.name) <- "Correct Name on IDs"
label(data.all$affirm.id.gender) <- "Correct Gender on IDs"
label(data.all$affirm.hormone) <- "Hormonal/Counseling Affirmation"
label(data.all$affirm.med.surg) <- "Medical/Surgical Affirmation"
```

# Create include variable

```{r}
data.all <- data.all %>% dplyr::mutate(include = 
                                         (nonbinary == "GQ/NB") &
                                         (!is.na(suicidal)),
                                       include = replace_na(include, FALSE)) 

save(data.all, file = paste(data_path, "data.all.Rda", sep = ""))
```


# Univariate Distributions

```{r}
data.include <- data.all %>% filter(include)

ggplot(data = data.include, aes(x = disc.trans)) +
  geom_histogram(binwidth = 1)

ggplot(data = data.include, aes(x = disc.non.trans)) +
  geom_histogram(binwidth = 1)

ggplot(data = data.include, aes(x = affirm.total)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.provider)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.family)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.id.name)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.id.gender)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.hormone)) +
  geom_bar()

ggplot(data = data.include, aes(x = affirm.med.surg)) +
  geom_bar()
```

```{r}
p1 <- ggplot(data = data.include, aes(x = disc.trans, y = ..density..)) +
  geom_histogram(binwidth = 1, fill = "darkblue", colour = "white") +
  labs(x = "Trans-Based Discrimination Score",
       y = element_blank(),
       title = "Distribution of Exposure (Discrimination)") +
  scale_x_continuous(breaks = 0:7) +
  scale_y_continuous(labels = scales::percent)
p1
```

```{r}
p2 <- ggplot(data = data.include, aes(x = affirm.total, y = ..density..)) +
  geom_histogram(binwidth = 1,fill = "darkblue", colour = "white") +
  labs(x = "Gender Affirmation Score",
       y = element_blank(),
       title = "Distribution of Moderator (Affirmation)") +
  scale_x_continuous(breaks = 0:10) +
  scale_y_continuous(labels = scales::percent)
p2
```

```{r}
p3 <- ggplot(data = data.include, aes(x = age, y = ..density..)) +
  geom_histogram(binwidth = 5, fill = "darkblue", colour = "white") +
  labs(x = "Trans-Based Discrimination Score",
       y = element_blank(),
       title = "Age") +
  scale_x_continuous(breaks = seq(0,100,10)) #+
#scale_y_continuous(labels = scales::percent)
p3
```



```{r}
sink("FreqDiscTrans.txt")
freq(data.include$disc.trans)
sink()

sink("FreqAffirmTotal.txt")
freq(data.include$affirm.total)
sink()

sink("PropTableDiscAffirmCat.txt")
round(prop.table(tab.disc.affirm)*100, 2)
sink()
```

```{r}
data.design <- data.all %>%
  dplyr::select(suicidal,
                disc.trans,
                affirm.provider,
                affirm.family,
                affirm.id.name,
                affirm.id.gender,
                affirm.hormone,
                affirm.med.surg,
                affirm.total,
                disc.non.trans,
                saab,
                intersex,
                passing,
                outness,
                orientation,
                age,
                education,
                race,
                poverty,
                insurance,
                homelessness,
                sexwork,
                illegalwork,
                citizenship,
                alcohol,
                sexualassault,
                disability,
                military,
                religious,
                SURVEYFULLWEIGHT,
                include)

save(data.design, file = paste(data_path, "data.design.Rda", sep = ""))
```


# Compute VIF to assess collinearity

```{r}
# quickly do survey design without imputation
USTS.design.raw.vif <- svydesign(ids = ~1,
                                 weights = ~SURVEYFULLWEIGHT,
                                 nest = FALSE,
                                 data = data.design)
USTS.design.vif <- subset(USTS.design.raw.vif, include == TRUE)

glm.vif <- svyglm(suicidal ~ disc.trans +
                    affirm.total + 
                    disc.non.trans + 
                    age + 
                    race + 
                    education + 
                    saab + 
                    intersex + 
                    passing + 
                    outness + 
                    orientation + 
                    poverty + 
                    insurance + 
                    homelessness + 
                    sexwork + 
                    illegalwork +
                    citizenship + 
                    alcohol + 
                    sexualassault + 
                    disability + 
                    military + 
                    religious,
                  family = quasibinomial(),
                  data   = data.design,
                  design = USTS.design.vif)
V.vif <- Vmat(mobj = glm.vif)
w.vif <- glm.vif$weights
data.vif <- data.include %>%
  dplyr::select(suicidal,
                disc.trans,
                affirm.total,
                disc.non.trans,
                age,
                race,
                education,
                saab,
                intersex,
                passing,
                outness,
                orientation,
                poverty,
                insurance,
                homelessness,
                sexwork,
                illegalwork,
                citizenship,
                alcohol,
                sexualassault,
                disability,
                military,
                religious)
X.vif <- model.matrix(~ disc.trans +
                        affirm.total + 
                        disc.non.trans + 
                        age + 
                        race + 
                        education + 
                        saab + 
                        intersex + 
                        passing + 
                        outness + 
                        orientation + 
                        poverty + 
                        insurance + 
                        homelessness + 
                        sexwork + 
                        illegalwork +
                        citizenship + 
                        alcohol + 
                        sexualassault + 
                        disability + 
                        military + 
                        religious,
                      data = data.vif)[,-1]
vif <- svyvif(X = X.vif, w = w.vif, V = V.vif)
vif

# Complex sample VIF > 10
vif[vif$svy.vif > 10,]

# Complex sample VIF > 5
vif[vif$svy.vif > 5 & vif$svy.vif <= 10,]
```

Results: Outness, Orientation, Education to be removed

# Re-Select columns for imputation and survey design

```{r}
data.design <- data.all %>%
  dplyr::select(suicidal,
                disc.trans,
                affirm.provider,
                affirm.family,
                affirm.id.name,
                affirm.id.gender,
                affirm.hormone,
                affirm.med.surg,
                affirm.total,
                disc.non.trans,
                saab,
                intersex,
                passing,
                age,
                race,
                poverty,
                insurance,
                homelessness,
                sexwork,
                illegalwork,
                citizenship,
                alcohol,
                sexualassault,
                disability,
                military,
                religious,
                SURVEYFULLWEIGHT,
                include)

save(data.design, file = paste(data_path, "data.design.Rda", sep = ""))
```

# Impute missing covariates

```{r}
# take a look at missingness in each column
p_missing <- unlist(lapply(data.design, function(x) sum(is.na(x))))/nrow(data.design)
sort(p_missing, decreasing = TRUE)

# define function to give us p-values later on
# from: https://thestatsgeek.com/2020/11/05/p-values-after-multiple-imputation-using-mitools-in-r/
MIcombineP <- function(MIcombineRes,digits=3) {
  tStat <- MIcombineRes$coefficients/sqrt(diag(MIcombineRes$variance))
  round(2*pt(-abs(tStat),df=MIcombineRes$df),digits)
}
```

```{r}
set.seed(42)
# Run mice with zero imputations initially
imp <- mice(data.design, maxit=0)

# Set predictor matrix to 0 for variables we don't want to use for imputation
pred.matrix <- imp$predictorMatrix
ignore <- c("SURVEYFULLWEIGHT", 
            "include", 
            "affirm.total")
ignore.1 <- c("affirm.provider",
              "affirm.family",
              "affirm.id.name",
              "affirm.id.gender",
              "affirm.hormone",
              "affirm.med.surg")
pred.matrix[, ignore] <- 0
pred.matrix[c(ignore),] <- 0
```

```{r}
# Actually impute using updated predictor matrix
imp2 <- mice(data.design, maxit = 5, 
             predictorMatrix = pred.matrix, 
             print =  FALSE)

# Create imputation list object
imp.long <- mice::complete(imp2, action="long", include = TRUE)
imp.list <- imputationList(split(imp.long, imp.long$.imp))
```

# Create survey design

```{r}
USTS.design.raw <- svydesign(ids = ~1,
                             weights = ~SURVEYFULLWEIGHT,
                             nest = FALSE,
                             data = imp.list)
```

```{r}
summary(USTS.design.raw$designs$`0`)
#summary(USTS.design.raw$designs$`1`)
#summary(USTS.design.raw$designs$`2`)
#summary(USTS.design.raw$designs$`3`)
#summary(USTS.design.raw$designs$`4`)
#summary(USTS.design.raw$designs$`5`)

sum(weights(USTS.design.raw, "sampling") == 0 )
```

# Subset the dataset using exclusion criteria

```{r}
USTS.design <- subset(USTS.design.raw, include == TRUE)
summary(USTS.design$designs$`0`)
#summary(USTS.design$designs$`1`)
#summary(USTS.design$designs$`2`)
#summary(USTS.design$designs$`3`)
#summary(USTS.design$designs$`4`)
#summary(USTS.design$designs$`5`)
```

# Compute basic statistics

```{r}
cors <- with(USTS.design, svycor(~ disc.trans + 
                                   affirm.total + 
                                   as.numeric(affirm.provider)+ 
                                   as.numeric(affirm.family)+ 
                                   as.numeric(affirm.id.name)+ 
                                   as.numeric(affirm.id.gender)+
                                   as.numeric(affirm.hormone)+ 
                                   as.numeric(affirm.med.surg), na.rm = T))
cors
#sum(abs(cors$cors)[1,] > 0.2) - 1
```

```{r}
MIcombine(with(USTS.design, svymean(~suicidal, na.rm = T)))
confint(MIcombine(with(USTS.design, svymean(~suicidal, na.rm = T))))

MIcombine(with(USTS.design, svyby(~suicidal, ~saab, svymean, na.rm = T)))
MIcombine(with(USTS.design, svyby(~suicidal, ~intersex, svymean, na.rm = T)))
```

```{r}
MIcombine(with(USTS.design, svymean(~disc.trans,  na.rm = T)))
confint(MIcombine(with(USTS.design, svymean(~disc.trans,  na.rm = T))))

MIcombine(with(USTS.design, svyby(~disc.trans, ~saab, svymean, na.rm = T)))
MIcombine(with(USTS.design, svyby(~disc.trans, ~intersex,  svymean, na.rm = T)))
```

```{r}
svymean(~affirm.total, USTS.design, na.rm = T)
confint(svymean(~affirm.total, USTS.design, na.rm = T))

svyby(~affirm.total, ~saab, USTS.design, svymean, na.rm = T)
svyby(~affirm.total, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~affirm.provider, USTS.design, na.rm = T)
confint(svymean(~affirm.provider, USTS.design, na.rm = T))

svyby(~affirm.provider, ~saab, USTS.design, svymean, na.rm = T)
svyby(~affirm.provider, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~poverty, USTS.design, na.rm = T)
confint(svymean(~poverty, USTS.design, na.rm = T))

svyby(~poverty, ~saab, USTS.design, svymean, na.rm = T)
svyby(~poverty, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~race, USTS.design, na.rm = T)
confint(svymean(~race, USTS.design, na.rm = T))

svyby(~race, ~saab, USTS.design, svymean, na.rm = T)
svyby(~race, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~education, USTS.design, na.rm = T)
confint(svymean(~education, USTS.design, na.rm = T))

svyby(~education, ~saab, USTS.design, svymean, na.rm = T)
svyby(~education, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~outness, USTS.design, na.rm = T)
confint(svymean(~outness, USTS.design, na.rm = T))

svyby(~outness, ~saab, USTS.design, svymean, na.rm = T)
svyby(~outness, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~passing, USTS.design, na.rm = T)
confint(svymean(~passing, USTS.design, na.rm = T))

svyby(~passing, ~saab, USTS.design, svymean, na.rm = T)
svyby(~passing, ~intersex, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~orientation, USTS.design, na.rm = T)
confint(svymean(~orientation, USTS.design, na.rm = T))

svyby(~orientation, ~saab, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~citizenship, USTS.design, na.rm = T)
confint(svymean(~citizenship, USTS.design, na.rm = T))

svyby(~citizenship, ~saab, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~disability, USTS.design, na.rm = T)
confint(svymean(~disability, USTS.design, na.rm = T))

svyby(~disability, ~saab, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~military, USTS.design, na.rm = T)
confint(svymean(~military, USTS.design, na.rm = T))

svyby(~military, ~saab, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~religious, USTS.design, na.rm = T)
confint(svymean(~religious, USTS.design, na.rm = T))

svyby(~religious, ~saab, USTS.design, svymean, na.rm = T)
```

```{r}
svymean(~disc.non.trans, USTS.design, na.rm = T)
confint(svymean(~disc.non.trans, USTS.design, na.rm = T))

svyby(~disc.non.trans, ~saab, USTS.design, svymean, na.rm = T)
```

# Models

```{r}
# Crude model
glm.crude <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans,
                                                family = quasibinomial(),
                                                data   = data.design)))

summary(glm.crude)

#exponentiated ORs
exp(coefficients(glm.crude))

#exponentiated 95 CIs
exp(confint(glm.crude))

#p-values
MIcombineP(glm.crude, digits=10)

#better output
#summ(glm.crude, exp = T, confint = T)

#sink("ModelCrude.txt")
#summ(glm.crude, exp = T, confint = T)
#sink()
```

```{r}
# Intermediate model - no interaction
glm.int <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans +
                                                affirm.total + 
                                                disc.non.trans + 
                                                age + 
                                                race + 
                                                saab + 
                                                intersex + 
                                                passing + 
                                                poverty + 
                                                insurance + 
                                                homelessness + 
                                                sexwork + 
                                                illegalwork +
                                                citizenship + 
                                                alcohol + 
                                                sexualassault + 
                                                disability + 
                                                military + 
                                                religious,
                                              family = quasibinomial(),
                                              data   = data.design)))

summary(glm.int)

#exponentiated ORs
exp(coefficients(glm.int))

#exponentiated 95 CIs
exp(confint(glm.int))

#p-values
MIcombineP(glm.int, digits=10)

#summ(glm.int, exp = T, confint = T)

#sink("ModelInt.txt")
#summ(glm.int, exp = T, confint = T)
#sink()
```

```{r}
# Interaction model - total affirmation
glm.ixn <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.total +
                                                disc.non.trans + 
                                                age + 
                                                race + 
                                                saab + 
                                                intersex + 
                                                passing + 
                                                poverty + 
                                                insurance + 
                                                homelessness + 
                                                sexwork + 
                                                illegalwork +
                                                citizenship + 
                                                alcohol + 
                                                sexualassault + 
                                                disability + 
                                                military + 
                                                religious,
                                              family = quasibinomial(),
                                              data   = data.design)))

summary(glm.ixn)

#exponentiated ORs
exp(coefficients(glm.ixn))

#exponentiated 95 CIs
exp(confint(glm.ixn))

#p-values
MIcombineP(glm.ixn, digits=10)

#summ(glm.ixn, exp = T, confint = T)

#sink("ModelIxn.txt")
#summ(glm.ixn, exp = T, confint = T)
#sink()
```

```{r}
# Simple slopes analysis - total affirmation
sim.slope <- sim_slopes(glm.ixn, pred = disc.trans, modx = affirm.total, modx.values = 0:11)
sim.slope
sim.slope.tidy <- tidy(sim.slope)
sim.slope.tidy

sim.slope.tidy <- sim.slope.tidy %>% 
  dplyr::mutate(estimate = round(exp(estimate),2),
                conf.low = round(exp(conf.low),2),
                conf.high = round(exp(conf.high),2),
                p.value = round(p.value,4)) %>%
  dplyr::select(modx.value, estimate, conf.low, conf.high, p.value)
sim.slope.tidy
save(sim.slope.tidy, file = paste(data_path, "sim.slope.tidy.Rda", sep = ""))

plot.sim.slope <- ggplot(sim.slope.tidy, aes(x = modx.value, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.tidy, aes(ymin = conf.low, ymax = conf.high)) +
  scale_x_continuous(breaks = 0:11) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure 3: Simple slopes for suicidal ideation by total gender affirmation \ninteraction, 2015 US Transgender Survey",
       x = "Total Affirmation Value",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold", size = 20))
plot.sim.slope
```


## Models for Individual Affirmation Categories

```{r}
# Interaction model - affirm provider only
glm.ixn.provider <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.provider +
                             disc.non.trans + 
                             age + 
                             race + 
                             saab + 
                             intersex + 
                             passing + 
                             poverty + 
                             insurance + 
                             homelessness + 
                             sexwork + 
                             illegalwork +
                             citizenship + 
                             alcohol + 
                             sexualassault + 
                             disability + 
                             military + 
                             religious,
                           family = quasibinomial(),
                           data   = data.design)))

summary(glm.ixn.provider)

#exponentiated ORs
exp(coefficients(glm.ixn.provider))

#exponentiated 95 CIs
exp(confint(glm.ixn.provider))

#p-values
MIcombineP(glm.ixn.provider, digits=10)



#summ(glm.ixn.provider, exp = T, confint = T)


#sink("ModelIxnProvider.txt")
#summ(glm.ixn.provider, exp = T, confint = T)
#sink()
```

```{r}
X.provider <- model.matrix(glm.ixn.provider)
dof.provider <- nrow(X.provider) - ncol(X.provider)
vcov.provider <- vcov(glm.ixn.provider)
t.provider <- qt(0.975, dof.provider)
coef.provider <- coef(glm.ixn.provider)

wald.provider <- wald.test(b = coef.provider, 
                           Sigma = vcov.provider, 
                           Terms = length(coef.provider))
p.ixn.provider <- wald.provider$result$chi2["P"]

sim.slope.provider <- data.frame( provider = factor(c("No Knowledgeable Provider",
                                                      "Has Knowledgeable Provider"),
                                                    levels = c("No Knowledgeable Provider",
                                                               "Has Knowledgeable Provider")),
                                  estimate = unname(
                                    c(glm.ixn.provider$coefficients[2],
                                      glm.ixn.provider$coefficients[19] +
                                        glm.ixn.provider$coefficients[2])),
                                  se = c(sqrt(vcov.provider[2,2]),
                                         sqrt(vcov.provider[2,2] + 
                                                vcov.provider[19,19] + 
                                                vcov.provider[2,19])))
sim.slope.provider <- sim.slope.provider %>% 
  dplyr::mutate(conf.low = exp(estimate - t.provider*se),
                conf.high = exp(estimate + t.provider*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.provider,
  )
save(sim.slope.provider, file = paste(data_path, "sim.slope.provider.Rda", sep = ""))

plot.sim.slope.provider <- ggplot(sim.slope.provider, aes(x = provider, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.provider, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by knowledgeable provider \ninteraction, 2015 US Transgender Survey",
       x = "Provider Knowledge",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.provider
```

```{r}
# Interaction model - affirm family only
glm.ixn.family <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.family +
                           disc.non.trans + 
                           age + 
                           race + 
                           saab + 
                           intersex + 
                           passing + 
                           poverty + 
                           insurance + 
                           homelessness + 
                           sexwork + 
                           illegalwork +
                           citizenship + 
                           alcohol + 
                           sexualassault + 
                           disability + 
                           military + 
                           religious,
                         family = quasibinomial(),
                         data   = data.design)))

summary(glm.ixn.family)

#exponentiated ORs
exp(coefficients(glm.ixn.family))

#exponentiated 95 CIs
exp(confint(glm.ixn.family))

#p-values
MIcombineP(glm.ixn.family, digits=10)



#summ(glm.ixn.family, exp = T, confint = T)

#sink("ModelIxnFamily.txt")
#summ(glm.ixn.family, exp = T, confint = T)
#sink()
```

```{r}
X.family <- model.matrix(glm.ixn.family)
dof.family <- nrow(X.family) - ncol(X.family)
vcov.family <- vcov(glm.ixn.family)
t.family <- qt(0.975, dof.family)
coef.family <- coef(glm.ixn.family)

wald.family <- wald.test(b = coef.family, 
                         Sigma = vcov.family, 
                         Terms = (length(coef.family) - 1):length(coef.family))
p.ixn.family <- wald.family$result$chi2["P"]


sim.slope.family <- data.frame(family = factor(c("Unsupportive", 
                                                 "Neutral", 
                                                 "Supportive"),
                                               levels = c("Unsupportive",
                                                          "Neutral", 
                                                          "Supportive")),
                               estimate = unname(
                                 c(glm.ixn.family$coefficients[2],
                                   glm.ixn.family$coefficients[20] +
                                     glm.ixn.family$coefficients[2],
                                   glm.ixn.family$coefficients[21] +
                                     glm.ixn.family$coefficients[2])),
                               se = c(sqrt(vcov.family[2,2]),
                                      sqrt(vcov.family[2,2] + 
                                             vcov.family[20,20] + 
                                             vcov.family[2,20]),
                                      sqrt(vcov.family[2,2] + 
                                             vcov.family[21,21] +
                                             vcov.family[2,21])))
sim.slope.family <- sim.slope.family %>% 
  dplyr::mutate(conf.low = exp(estimate - t.family*se),
                conf.high = exp(estimate + t.family*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.family,
  )

save(sim.slope.family, file = paste(data_path, "sim.slope.family.Rda", sep = ""))

plot.sim.slope.family <- ggplot(sim.slope.family, aes(x = family, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.family, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by family affirmation \ninteraction, 2015 US Transgender Survey",
       x = "Family Supportiveness",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.family
```

```{r}
# Interaction model - affirm IDs name only
glm.ixn.id.name <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.id.name +
                            disc.non.trans + 
                            age + 
                            race + 
                            saab + 
                            intersex + 
                            passing + 
                            poverty + 
                            insurance + 
                            homelessness + 
                            sexwork + 
                            illegalwork +
                            citizenship + 
                            alcohol + 
                            sexualassault + 
                            disability + 
                            military + 
                            religious,
                          family = quasibinomial(),
                          data   = data.design)))

summary(glm.ixn.id.name)

#exponentiated ORs
exp(coefficients(glm.ixn.id.name))

#exponentiated 95 CIs
exp(confint(glm.ixn.id.name))

#p-values
MIcombineP(glm.ixn.id.name, digits=10)



#summ(glm.ixn.id.name, exp = T, confint = T)

#sink("ModelIxnIDsName.txt")
#summ(glm.ixn.id.name, exp = T, confint = T)
#sink()
```

```{r}
X.id.name <- model.matrix(glm.ixn.id.name)
dof.id.name <- nrow(X.id.name) - ncol(X.id.name)
vcov.id.name <- vcov(glm.ixn.id.name)
t.id.name <- qt(0.975, dof.id.name)
coef.id.name <- coef(glm.ixn.id.name)

wald.id.name <- wald.test(b = coef.id.name, 
                          Sigma = vcov.id.name, 
                          Terms = (length(coef.id.name) - 1):length(coef.id.name))
p.ixn.id.name <- wald.id.name$result$chi2["P"]


sim.slope.id.name <- data.frame( id.name = factor(c("None", "Some", "All"),
                                                  levels = c("None", "Some", "All")),
                                 estimate = unname(
                                   c(glm.ixn.id.name$coefficients[2],
                                     glm.ixn.id.name$coefficients[20] +
                                       glm.ixn.id.name$coefficients[2],
                                     glm.ixn.id.name$coefficients[21] +
                                       glm.ixn.id.name$coefficients[2])),
                                 se = c(sqrt(vcov.id.name[2,2]),
                                        sqrt(vcov.id.name[2,2] + 
                                               vcov.id.name[20,20] + 
                                               vcov.id.name[2,20]),
                                        sqrt(vcov.id.name[2,2] + 
                                               vcov.id.name[21,21] +
                                               vcov.id.name[2,21])))
sim.slope.id.name <- sim.slope.id.name %>% 
  dplyr::mutate(conf.low = exp(estimate - t.id.name*se),
                conf.high = exp(estimate + t.id.name*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.id.name,
  )
save(sim.slope.id.name, file = paste(data_path, "sim.slope.id.name.Rda", sep = ""))

plot.sim.slope.id.name <- ggplot(sim.slope.id.name, aes(x = id.name, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.id.name, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by correct ID name \ninteraction, 2015 US Transgender Survey",
       x = "IDs with Correct Name",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.id.name
```


```{r}
# Interaction model - affirm IDs gender only
glm.ixn.id.gender <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.id.gender +
                              disc.non.trans + 
                              age + 
                              race + 
                              saab + 
                              intersex + 
                              passing + 
                              poverty + 
                              insurance + 
                              homelessness + 
                              sexwork + 
                              illegalwork +
                              citizenship + 
                              alcohol + 
                              sexualassault + 
                              disability + 
                              military + 
                              religious,
                            family = quasibinomial(),
                            data   = data.design)))

summary(glm.ixn.id.gender)

#exponentiated ORs
exp(coefficients(glm.ixn.id.gender))

#exponentiated 95 CIs
exp(confint(glm.ixn.id.gender))

#p-values
MIcombineP(glm.ixn.id.gender, digits=10)

#summ(glm.ixn.id.gender, exp = T, confint = T)

#sink("ModelIxnIDsGender.txt")
#summ(glm.ixn.id.gender, exp = T, confint = T)
#sink()
```

```{r}
X.id.gender <- model.matrix(glm.ixn.id.gender)
dof.id.gender <- nrow(X.id.gender) - ncol(X.id.gender)
vcov.id.gender <- vcov(glm.ixn.id.gender)
t.id.gender <- qt(0.975, dof.id.gender)
coef.id.gender <- coef(glm.ixn.id.gender)

wald.id.gender <- wald.test(b = coef.id.gender, 
                            Sigma = vcov.id.gender, 
                            Terms = (length(coef.id.gender) - 1):length(coef.id.gender))
p.ixn.id.gender <- wald.id.gender$result$chi2["P"]


sim.slope.id.gender <- data.frame( id.gender = factor(c("None", "Some", "All"),
                                                      levels = c("None", "Some", "All")),
                                   estimate = unname(
                                     c(glm.ixn.id.gender$coefficients[2],
                                       glm.ixn.id.gender$coefficients[20] +
                                         glm.ixn.id.gender$coefficients[2],
                                       glm.ixn.id.gender$coefficients[21] +
                                         glm.ixn.id.gender$coefficients[2])),
                                   se = c(sqrt(vcov.id.gender[2,2]),
                                          sqrt(vcov.id.gender[2,2] + 
                                                 vcov.id.gender[20,20] + 
                                                 vcov.id.gender[2,20]),
                                          sqrt(vcov.id.gender[2,2] + 
                                                 vcov.id.gender[21,21] +
                                                 vcov.id.gender[2,21])))
sim.slope.id.gender <- sim.slope.id.gender %>% 
  dplyr::mutate(conf.low = exp(estimate - t.id.gender*se),
                conf.high = exp(estimate + t.id.gender*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.id.gender,
  )

save(sim.slope.id.gender, file = paste(data_path, "sim.slope.id.gender.Rda", sep = ""))


plot.sim.slope.id.gender <- ggplot(sim.slope.id.gender, aes(x = id.gender, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.id.gender, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by correct ID gender \ninteraction, 2015 US Transgender Survey",
       x = "IDs with Correct Gender",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.id.gender
```

```{r}
# Interaction model - affirm hormone/counseling only
glm.ixn.hormone <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.hormone +
                            disc.non.trans + 
                            age + 
                            race + 
                            saab + 
                            intersex + 
                            passing + 
                            poverty + 
                            insurance + 
                            homelessness + 
                            sexwork + 
                            illegalwork +
                            citizenship + 
                            alcohol + 
                            sexualassault + 
                            disability + 
                            military + 
                            religious,
                          family = quasibinomial(),
                          data   = data.design)))

summary(glm.ixn.hormone)

#exponentiated ORs
exp(coefficients(glm.ixn.hormone))

#exponentiated 95 CIs
exp(confint(glm.ixn.hormone))

#p-values
MIcombineP(glm.ixn.hormone, digits=10)

#summ(glm.ixn.hormone, exp = T, confint = T)

#sink("ModelIxnHormone.txt")
#summ(glm.ixn.hormone, exp = T, confint = T)
#sink()
```

```{r}
X.hormone <- model.matrix(glm.ixn.hormone)
dof.hormone <- nrow(X.hormone) - ncol(X.hormone)
vcov.hormone <- vcov(glm.ixn.hormone)
t.hormone <- qt(0.975, dof.hormone)
coef.hormone <- coef(glm.ixn.hormone)

wald.hormone <- wald.test(b = coef.hormone, 
                          Sigma = vcov.hormone, 
                          Terms = (length(coef.hormone) - 1):length(coef.hormone))
p.ixn.hormone <- wald.hormone$result$chi2["P"]


sim.slope.hormone <- data.frame( hormone = factor(c("None", "Some", "All"),
                                                  levels = c("None", "Some", "All")),
                                 estimate = unname(
                                   c(glm.ixn.hormone$coefficients[2],
                                     glm.ixn.hormone$coefficients[20] +
                                       glm.ixn.hormone$coefficients[2],
                                     glm.ixn.hormone$coefficients[21] +
                                       glm.ixn.hormone$coefficients[2])),
                                 se = c(sqrt(vcov.hormone[2,2]),
                                        sqrt(vcov.hormone[2,2] + 
                                               vcov.hormone[20,20] + 
                                               vcov.hormone[2,20]),
                                        sqrt(vcov.hormone[2,2] + 
                                               vcov.hormone[21,21] +
                                               vcov.hormone[2,21])))
sim.slope.hormone <- sim.slope.hormone %>% 
  dplyr::mutate(conf.low = exp(estimate - t.hormone*se),
                conf.high = exp(estimate + t.hormone*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.hormone,
  )

save(sim.slope.hormone, file = paste(data_path, "sim.slope.hormone.Rda", sep = ""))

plot.sim.slope.hormone <- ggplot(sim.slope.hormone, aes(x = hormone, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.hormone, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by hormone/counselling affirmation \ninteraction, 2015 US Transgender Survey",
       x = "Desired Hormones/Counselling Acquired",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.hormone
```

```{r}
# Interaction model - affirm medical/surgical only
glm.ixn.med <- MIcombine(with(USTS.design, svyglm(suicidal ~ disc.trans*affirm.med.surg +
                        disc.non.trans + 
                        age + 
                        race + 
                        saab + 
                        intersex + 
                        passing + 
                        poverty + 
                        insurance + 
                        homelessness + 
                        sexwork + 
                        illegalwork +
                        citizenship + 
                        alcohol + 
                        sexualassault + 
                        disability + 
                        military + 
                        religious,
                      family = quasibinomial(),
                      data   = data.design)))

summary(glm.ixn.med)

#exponentiated ORs
exp(coefficients(glm.ixn.med))

#exponentiated 95 CIs
exp(confint(glm.ixn.med))

#p-values
MIcombineP(glm.ixn.med, digits=10)

#summ(glm.ixn.med, exp = T, confint = T)

#sink("ModelIxnMed.txt")
#summ(glm.ixn.med, exp = T, confint = T)
#sink()
```

```{r}
X.med <- model.matrix(glm.ixn.med)
dof.med <- nrow(X.med) - ncol(X.med)
vcov.med <- vcov(glm.ixn.med)
t.med <- qt(0.975, dof.med)
coef.med <- coef(glm.ixn.med)

wald.med <- wald.test(b = coef.med, 
                      Sigma = vcov.med, 
                      Terms = (length(coef.med) - 1):length(coef.med))
p.ixn.med <- wald.med$result$chi2["P"]


sim.slope.med <- data.frame( med = factor(c("None", "Some", "All"),
                                          levels = c("None", "Some", "All")),
                             estimate = unname(
                               c(glm.ixn.med$coefficients[2],
                                 glm.ixn.med$coefficients[20] +
                                   glm.ixn.med$coefficients[2],
                                 glm.ixn.med$coefficients[21] +
                                   glm.ixn.med$coefficients[2])),
                             se = c(sqrt(vcov.med[2,2]),
                                    sqrt(vcov.med[2,2] + 
                                           vcov.med[20,20] + 
                                           vcov.med[2,20]),
                                    sqrt(vcov.med[2,2] + 
                                           vcov.med[21,21] +
                                           vcov.med[2,21])))
sim.slope.med <- sim.slope.med %>% 
  dplyr::mutate(conf.low = exp(estimate - t.med*se),
                conf.high = exp(estimate + t.med*se),
                estimate = exp(estimate),
                p.interaction = p.ixn.med,
  )

save(sim.slope.med, file = paste(data_path, "sim.slope.med.Rda", sep = ""))


plot.sim.slope.med <- ggplot(sim.slope.med, aes(x = med, y = estimate)) +
  geom_point() +
  geom_errorbar(data = sim.slope.med, aes(ymin = conf.low, ymax = conf.high)) +
  #scale_x_continuous(breaks = 0:2) +
  geom_abline(intercept = 1, slope = 0, linetype = "dashed") +
  labs(title = "Figure  : Simple slopes for suicidal ideation by medical/surgical affirmation \ninteraction, 2015 US Transgender Survey",
       x = "Desired Medical/Surgical Procedures Acquired",
       y = "Slope of Trans-Based Discrimination") +
  theme(text = element_text(family = "Times New Roman", face = "bold"))
plot.sim.slope.med
```

# Create Tables 1-3

```{r}
#USTSsvy <- svydesign(ids = ~1,
#                     weights = ~SURVEYFULLWEIGHT,
#                     nest = FALSE,
#                     data = data.all)
vars <- c("suicidal", 
          "disc.trans", 
          "disc.non.trans", 
          "affirm.total", 
          "affirm.provider", 
          "affirm.family", 
          "affirm.id.name", 
          "affirm.id.gender", 
          "affirm.hormone", 
          "affirm.med.surg", 
          "age",
          "race",
          "education",
          "saab",
          "intersex",
          "passing",
          "outness",
          "orientation",
          "poverty",
          "insurance",
          "homelessness",
          "sexwork",
          "illegalwork",
          "citizenship",
          "alcohol",
          "sexualassault",
          "disability",
          "military",
          "religious")
fvars <- c("suicidal",  
           "affirm.family", 
           "affirm.provider", 
           "affirm.id.name", 
           "affirm.id.gender", 
           "affirm.hormone", 
           "affirm.med.surg", 
           "race",
           "education",
           "saab",
           "intersex",
           "passing",
           "outness",
           "orientation",
           "poverty",
           "insurance",
           "homelessness",
           "sexwork",
           "illegalwork",
           "citizenship",
           "alcohol",
           "sexualassault",
           "disability",
           "military",
           "religious")
```


```{r}
tab1 <- svyCreateTableOne(data = USTS.design,
                          vars = vars,
                          factorVars = fvars,
                          
                          includeNA = FALSE,
                          test=FALSE)
summary(tab1)

print(tab1, showAllLevels = T, varLabels = T)

# t1 <- kable(print(tab1,
#                    showAllLevels = TRUE,
#                    varLabels = TRUE,
#                    printToggle = FALSE,
#                    noSpaces = TRUE,
#                    catDigits=1,
#                    contDigits=1),
#       align = 'lc',
#       format = "latex",
#       col.names = c("", "Overall"),
#       booktabs = TRUE,
#       caption=paste("Descriptive statistics for participants in",
#                                  "2015 U.S. Transgender Survey."))
# 
# t1 %>% kable_styling(latex_options = c("striped", "hold_position")) %>% save_kable("Table 1.pdf", keep_tex = TRUE)
```

```{r}
sink("Table1Summary.txt")
print(tab1, showAllLevels = T, varLabels = T)
sink()
```

```{r}
write.csv(tab1, file = "Table1.csv")
```



```{r}
tab2 <- svyCreateTableOne(data = USTS.design,
                          vars = setdiff(vars,c("disc.trans")),
                          factorVars = setdiff(fvars),
                          test = TRUE)
summary(tab2)
```

```{r}
sink("Table2Summary.txt")
print(tab2, showAllLevels = T, varLabels = T)
sink()
```

```{r}
svyby(~disc.trans, ~suicidal, USTS.design, svymean, na.rm = T)
svychisq(~disc.trans + suicidal, USTS.design, statistic = "F")

svycor(~disc.trans + affirm.total, USTS.design)$cors
```

```{r}
svychisq(~disc.trans + citizenship, USTS.design, statistic = "F")
```

```{r}
svycor(~disc.trans + age, USTS.design)$cors
```

```{r}
svyby(~disc.trans, ~poverty, USTS.design, svymean, na.rm = T)
svychisq(~disc.trans + poverty, USTS.design, statistic = "F")
```


```{r}
svyby(~disc.trans, ~citizenship, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~passing, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~outness, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~orientation, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~race, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~age, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~education, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~disability, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~military, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~religious, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~saab, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~poverty, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~disc.non.trans, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.provider, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.family, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.id.name, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.id.gender, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.hormone, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.med.surg, USTS.design, svymean, na.rm = T)
svyby(~disc.trans, ~affirm.total, USTS.design, svymean, na.rm = T)
```

```{r}
tab3 <- svyCreateTableOne(data = USTS.design,
                          vars = setdiff(vars,c("suicidal")),
                          factorVars = setdiff(fvars,c("suicidal")),
                          strata = "suicidal",
                          test=TRUE)
summary(tab3)
```

```{r}
sink("Table3Summary.txt")
print(tab3, showAllLevels = T, varLabels = T)
sink()
```

```{r}
svychisq(~suicidal + disc.trans, USTS.design, statistic = "F")
svychisq(~suicidal + affirm.total, USTS.design, statistic = "F")
svychisq(~suicidal + disc.non.trans, USTS.design, statistic = "F")
svychisq(~suicidal + age, USTS.design, statistic = "F")

svyby(~suicidal, ~affirm.family, USTS.design, svymean, na.rm = T)*100
svychisq(~suicidal + affirm.family, USTS.design, statistic = "Chisq")

svyby(~suicidal, ~affirm.provider, USTS.design, svymean, na.rm = T)*100
svychisq(~suicidal + affirm.provider, USTS.design, statistic = "Chisq")
```


```{r}
svyby(~suicidal, ~poverty, USTS.design, svymean, na.rm = T)*100
svychisq(~suicidal + poverty, USTS.design, statistic = "Chisq")
```
